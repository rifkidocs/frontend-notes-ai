# WebSocket API Documentation (Frontend Guide)

Dokumen ini berisi spesifikasi teknis untuk implementasi fitur Real-time Collaboration di frontend. Backend menggunakan `Socket.io` dan membutuhkan autentikasi JWT.

## ðŸ”Œ Connection Setup

**Endpoint:** `http://localhost:5000` (atau sesuaikan dengan environment)
**Path:** `/socket.io/` (Default)
**Transports:** `['websocket', 'polling']`

### Authentication
Token JWT harus dikirim saat handshake awal. Bisa melalui objek `auth` atau header.

```javascript
import { io } from "socket.io-client";

const socket = io("http://localhost:5000", {
  auth: {
    token: "YOUR_JWT_TOKEN" // Dapatkan dari login response
  },
  // Alternatif via headers:
  // extraHeaders: {
  //   Authorization: "Bearer YOUR_JWT_TOKEN"
  // }
});
```

---

## ðŸ“„ Document Events

Digunakan untuk bergabung ke sesi edit, meninggalkan sesi, dan sinkronisasi konten.

### 1. Join Document room
Panggil ini saat user membuka halaman editor.

*   **Emit (Client -> Server):** `document:join`
    ```javascript
    socket.emit("document:join", { noteId: "note_123" });
    ```

*   **Listen (Server -> Client):** `document:users` (Daftar user saat ini)
    ```javascript
    socket.on("document:users", ({ users }) => {
      console.log("Current users in room:", users);
      // users: [{ id: "user_1", name: "Alice" }, ...]
    });
    ```

*   **Listen (Server -> Client):** `document:user:joined` (Notifikasi user baru masuk)
    ```javascript
    socket.on("document:user:joined", ({ userId, userName, socketId }) => {
      console.log(`${userName} joined!`);
    });
    ```

### 2. Leave Document
Panggil saat user menutup tab atau pindah halaman (unmount component).

*   **Emit:** `document:leave`
    ```javascript
    socket.emit("document:leave", { noteId: "note_123" });
    ```

*   **Listen:** `document:user:left`
    ```javascript
    socket.on("document:user:left", ({ userId }) => {
      // Remove user cursor and avatar
    });
    ```

### 3. Sync Content (Editing)
Sistem menggunakan pelacakan versi sederhana. **Note:** Untuk produksi skala besar, disarankan menggunakan library OT/CRDT (seperti Yjs), namun implementasi saat ini menggunakan array operations.

*   **Emit:** `document:edit`
    ```javascript
    socket.emit("document:edit", {
      noteId: "note_123",
      version: 5, // Versi dokumen terakhir yang diketahui client
      operations: [
        // Format operasi tergantung editor (e.g., Delta untuk Quill/Slate)
        { insert: "Hello world", at: 0 }
      ]
    });
    ```

*   **Listen:** `document:updated` (Broadcast ke semua client di room)
    ```javascript
    socket.on("document:updated", ({ operations, version, userId, userName, timestamp }) => {
      if (userId !== myUserId) {
        // Apply operations to editor
        editor.applyOps(operations);
      }
      // Update local version ref
      currentVersion = version;
    });
    ```

*   **Error Handling (Conflict):** `document:conflict`
    Terjadi jika client mencoba mengirim edit dengan versi kadaluarsa.
    ```javascript
    socket.on("document:conflict", ({ currentVersion, yourVersion }) => {
      // Logic untuk fetch ulang dokumen penuh atau rebase changes
      console.warn("Version mismatch, reloading document...");
    });
    ```

---

## ðŸ–±ï¸ Cursor & Presence

Fitur visual untuk melihat siapa yang sedang aktif dan di mana mereka mengetik.

### 1. Cursor Movement
Kirim posisi kursor setiap kali user memindahkan kursor atau mengetik. (Gunakan debounce/throttle ~50-100ms agar tidak spam).

*   **Emit:** `cursor:update`
    ```javascript
    socket.emit("cursor:update", {
      noteId: "note_123",
      position: { line: 10, ch: 5 } // Sesuaikan dengan format editor (e.g., offset/path)
    });
    ```

*   **Listen:** `cursor:moved`
    ```javascript
    socket.on("cursor:moved", ({ userId, userName, position, color }) => {
      // Render remote cursor
      // color: Hex color generated by server consistent for userId
      renderRemoteCursor(userId, position, color, userName);
    });
    ```

### 2. Presence (Online Status)
Mengetahui siapa saja yang sedang online (mirip dengan event join, tapi lebih spesifik untuk status bar).

*   **Emit:** `presence:subscribe`
    ```javascript
    socket.emit("presence:subscribe", { noteId: "note_123" });
    ```

*   **Listen:** `presence:online`
    ```javascript
    socket.on("presence:online", ({ users }) => {
      // Update daftar avatar di header
    });
    ```

*   **Listen:** `presence:offline`
    ```javascript
    socket.on("presence:offline", ({ userId }) => {
      // Set status user jadi offline/greyed out
    });
    ```

---

## âš ï¸ Error Handling

Socket.io akan mengirim event `error` jika terjadi masalah (auth gagal, permission denied, dll).

```javascript
socket.on("error", (err) => {
  console.error("Socket error:", err.message);
  // Tampilkan toast/alert ke user
});

socket.on("connect_error", (err) => {
  console.error("Connection failed:", err.message);
  // Biasanya karena token invalid atau server down
});
```
